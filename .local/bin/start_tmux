#!/bin/env bash
# Start tmux without replacing shell. Intented to be run by startup scripts.
#
# Signals:
#   0 = normal exit process, shell should not continue execution
#   1 = tmux already in execution (unset $TMUX), or other
#   3 = signalled exit process, shell should continue execution
#   127 = tmux not found

if [ -z "$(type tmux 2> /dev/null)" ]; then
  echo "tmux binary not found. Exitting."
  exit 127
fi

if [ -n "$TMUX" ]; then
  # shellcheck disable=SC2016
  echo 'tmux already in execution. Unset "$TMUX" to force.'
  exit 1
fi

# https://unix.stackexchange.com/a/586485

# Configure a signal handler to allow the tmux session to toggle the exit flag:
export EXIT_FLAG=1
trap 'EXIT_FLAG=$(($EXIT_FLAG ^ 1))' USR1

# Start tmux:
tmux new-session -s "SH$$" "TMUX_PPID=$$ $SHELL -l"\; setenv TMUX_PPID $$

# Exit, assuming the exit flag has not been flipped:
if [ "$EXIT_FLAG" == "1" ]; then
  exit 0
fi

# Otherwise 
exit 3
